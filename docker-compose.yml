version: "3"

volumes:
  dbdata:

services:
  mysql-1:
    container_name: mysql-1
    image: mysql:latest    
    restart: on-failure
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: devnest1234 
      MYSQL_DATABASE: devnest
      MYSQL_USER: devnest
      MYSQL_PASSWORD: devnest1234
    volumes:
      - dbdata:/var/lib/mysql
    cap_add:
      - SYS_NICE  # CAP_SYS_NICE

  mysql-2:
    container_name: mysql-2
    image: mysql:latest    
    restart: on-failure
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: devnest1234 
      MYSQL_DATABASE: devnest
      MYSQL_USER: devnest
      MYSQL_PASSWORD: devnest1234
    volumes:
      - dbdata:/var/lib/mysql
    cap_add:
      - SYS_NICE  # CAP_SYS_NICE

  mysql-loadbalancer:
    container_name: mysql-loadbalancer
    build: ./mysql_HAProxy
    restart: on-failure
    depends_on:
      - mysql-1
      - mysql-2
  
  internalService-1:
    container_name: internalService-1
    image: ghcr.io/darkops96/devnest-internalservice:latest
    restart: on-failure
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-loadbalancer:3306/devnest?serverTimezone=UTC
    depends_on:
      - mysql-loadbalancer

  internalService-2:
    container_name: internalService-2
    image: ghcr.io/darkops96/devnest-internalservice:latest
    restart: on-failure
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-loadbalancer:3306/devnest?serverTimezone=UTC
    depends_on:
      - mysql-loadbalancer

  internal-loadbalancer:
    container_name: internal-loadbalancer
    build: ./internalService_HAProxy
    restart: on-failure
    depends_on:
      - internalService-1
      - internalService-2

  devNest-1:
    container_name: devNest-1
    image: ghcr.io/darkops96/devnest-webapp:latest
    restart: on-failure
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-loadbalancer:3306/devnest?serverTimezone=UTC
      INTERNALSERVICE_BASEURI: http://internal-loadbalancer:80
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    depends_on:
      - mysql-loadbalancer
      - internal-loadbalancer

  devNest-2:
    container_name: devNest-2
    image: ghcr.io/darkops96/devnest-webapp:latest
    restart: on-failure
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-loadbalancer:3306/devnest?serverTimezone=UTC
      INTERNALSERVICE_BASEURI: http://internal-loadbalancer:80
    depends_on:
      - mysql-loadbalancer
      - internal-loadbalancer

  webapp-loadbalancer:
    container_name: webapp-loadbalancer
    build: ./web_HAProxy    
    restart: on-failure
    ports:
      - 443:443
    depends_on:
      - devNest-1
      - devNest-2
